---
title: "PEST08 Timelines"
output: html_notebook
---
```{r, echo=FALSE}

# Data is from Labware and consists of the following columns:
#SAMPLE_NUMBER
#ANALYSIS
#LOGIN_DATE
#RECD_DATE
#DATE_STARTED
#RELEASED_ON
#CHANGED_ON
#DATE_REVIEWED
#CUSTOMER
#STATUS
#
# The filter date is set in line 46 and the header manually set in line 80.
# The title in line 2 is manually set.
```


```{r, echo = FALSE, message=FALSE}
# Packages ---------------------------------------------------------------
library(readxl)
library(lubridate)
library(tidyr)
library(dplyr)
library(ggplot2)
library(psych)

# Data In ----------------------------------------------------------------
data.in <- read_excel("H:/GitHub Projects/TAT-Investigation/data/PEST08_2017b.xlsx", 
    col_types = c("numeric", "text", "text", 
        "date", "date", "date", "date", 
        "date", "date", "date","text"))

data.in <- data.in[,c(-3,-9)]


colnames(data.in)[3] <- "Logged"
colnames(data.in)[4] <- "Received"
colnames(data.in)[5] <- "Started"
colnames(data.in)[6] <- "Completed"
colnames(data.in)[7] <- "Released"
colnames(data.in)[8] <- "Reviewed"

prep <- read_excel("H:/GitHub Projects/TAT-Investigation/data/PREP.xlsx", col_types = c("numeric", 
    "date", "text", "text", "text", "date", 
    "date"))

prep <- prep[,c(1,6,7)]
colnames(prep)[2] <- "Prep_In"
colnames(prep)[3] <- "Prep_Out"

data.all <- merge(data.in, prep, by.x = "SAMPLE_NUMBER", by.y = "SAMPLE_NUMBER", all = TRUE)

data.in <- data.all %>% 
  filter(Logged > "2017/06/01")

data.in <- data.in[,c(1:4,10,11, 5:8,9)]

a <- sapply(data.in[,3], as.numeric)/(3600*24)
b <- sapply(data.in[,4], as.numeric)/(3600*24)
c <- sapply(data.in[,5], as.numeric)/(3600*24)
d <- sapply(data.in[,6], as.numeric)/(3600*24)
e <- sapply(data.in[,7], as.numeric)/(3600*24)
f <- sapply(data.in[,8], as.numeric)/(3600*24)
g <- sapply(data.in[,9], as.numeric)/(3600*24)
h <- sapply(data.in[,10], as.numeric)/(3600*24)

set <- as.data.frame(cbind(a,b,c,d,e,f,g,h))

set <- cbind(data.in[,c(1,2,11)],set)

set <- set[,c(1,2,4:11,3)]


colnames(set)[3] <- "Logged"
colnames(set)[4] <- "Received"
colnames(set)[5] <- "Prep_In"
colnames(set)[6] <- "Prep_Out"
colnames(set)[7] <- "Started"
colnames(set)[8] <- "Completed"
colnames(set)[9] <- "Released"
colnames(set)[10] <- "Reviewed"


set$Transit <- set$Prep_In - set$Received
set$Prep <- set$Prep_Out - set$Prep_In
set$Waiting <- set$Started - set$Prep_Out
set$Test_Time <- set$Completed - set$Started
set$Checked <- set$Released - set$Completed
set$Review <- set$Reviewed - set$Released
set$TAT <- set$Reviewed - set$Logged

#set <- na.omit(set)

n <- nrow(set)
m <- nrow(data.in)
cust <- length(unique(set$CUSTOMER))


```

#### Period: Since June 1st, 2017
&nbsp;
A total of `r m` samples were received.  Of these `r n` were completed.  The remainder are either in progress or were cancelled.

The samples came from `r cust` separate customers.

&nbsp;


#### Breakdown of times
&nbsp;


```{r, echo=FALSE}
set_plot_1 <- ggplot(set, aes(x=Waiting)) +
        geom_histogram(binwidth = 0.2, fill = "cornflowerblue", colour = "grey85")+
        labs(title = "Start Times for PEST08", subtitle = "Days from Receipt at the Laboratory to Commencing Testing", x="Days", y="Samples") +
        theme_bw() +
        theme(panel.grid.major = element_line(size = 0.5, color = "grey"), 
              axis.line = element_line(size = 0.7, color = "black"), 
              text = element_text(size = 10))
set_plot_1
```

&nbsp;

```{r, echo=FALSE}
set_plot_3 <- ggplot(set, aes(x=Checked)) +
        geom_histogram(binwidth = 0.2, fill = "cornflowerblue", colour = "grey85")+
        labs(title = "Release Times for PEST08", subtitle = "Days from Completing Testing to Releasing", x="Days", y="Samples") +
        theme_bw() +
        theme(panel.grid.major = element_line(size = 0.5, color = "grey"), 
              axis.line = element_line(size = 0.7, color = "black"), 
              text = element_text(size = 10))
set_plot_3
```
&nbsp;



```{r, echo=FALSE}
set_plot_2 <- ggplot(set, aes(x=TAT)) +
  geom_histogram(binwidth = 0.2, fill = "cornflowerblue", colour = "grey85")+
  labs(title = "Overall TAT for PEST08", subtitle = "Days from Logging the Sample to Reviewing the Sample", x="Days", y="Samples") +
  theme_bw() +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"), 
        axis.line = element_line(size = 0.7, color = "black"), 
        text = element_text(size = 10))

set_plot_2
```
&nbsp;


#### Summary Data (Days)

* Transit = time from being logged to being received.
* Lab-Duration = time from being received to being released.
* Review = time from being released to being teviewed.
* TAT = time from being logged to being reviewed.


```{r, echo=FALSE}
options(digits=3)
describe(set[,c(11:16)], skew = TRUE)
```
&nbsp;

#### TAT by Client

Where multiple samples overlap, the intensity of the dot increases.

```{r, echo=FALSE}
set_plot_4 <- ggplot(set, aes(x=TAT, y=CUSTOMER)) +
  geom_point(size=4, shape = 21, fill="cornflowerblue", alpha = 0.5)+
  labs(title = "TAT by Client", subtitle = "Days from Logging the Sample to Reviewing the Sample", x="Days", y="") +
  theme_bw() +
  theme(panel.grid.major = element_line(size = 0.5, color = "grey"), 
        axis.line = element_line(size = 0.7, color = "black"), 
        text = element_text(size = 10))

set_plot_4
```
